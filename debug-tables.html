<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ —Ç–∞–±–ª–∏—Ü branches –∏ territories</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>üîç –û—Ç–ª–∞–¥–∫–∞ —Ç–∞–±–ª–∏—Ü branches –∏ territories</h1>
    <div id="results"></div>

    <script>
        const supabaseUrl = 'https://oaockmesooydvausfoca.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hb2NrbWVzb295ZHZhdXNmb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzI4NDEsImV4cCI6MjA2Njk0ODg0MX0.gwWS35APlyST7_IUvQvJtGO4QmGsvbE95lnQf0H1PUE';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        const resultsDiv = document.getElementById('results');

        async function debugTables() {
            resultsDiv.innerHTML = '<p>üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</p>';

            try {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–ª–∏–∞–ª—ã (branches)
                const { data: branches, error: branchesError } = await supabase
                    .from('branches')
                    .select('id, name, code, address')
                    .order('name');

                if (branchesError) {
                    resultsDiv.innerHTML += `<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤: ${branchesError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<h2>üè¢ –§–∏–ª–∏–∞–ª—ã (branches):</h2>`;
                    branches.forEach(b => {
                        resultsDiv.innerHTML += `<p>- ${b.name} (${b.code || '–±–µ–∑ –∫–æ–¥–∞'}) - ID: ${b.id}</p>`;
                    });
                }

                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (territories)
                const { data: territories, error: territoriesError } = await supabase
                    .from('territories')
                    .select('id, name, region')
                    .order('name');

                if (territoriesError) {
                    resultsDiv.innerHTML += `<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π: ${territoriesError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<h2>üó∫Ô∏è –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (territories):</h2>`;
                    territories.forEach(t => {
                        resultsDiv.innerHTML += `<p>- ${t.name} (${t.region || '–±–µ–∑ —Ä–µ–≥–∏–æ–Ω–∞'}) - ID: ${t.id}</p>`;
                    });
                }

                // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–µ–Ω–µ—Ä–æ–≤ —Å –∏—Ö —Ñ–∏–ª–∏–∞–ª–∞–º–∏
                const { data: trainers, error: trainersError } = await supabase
                    .from('users')
                    .select(`
                        id, full_name, email, branch_id,
                        branch:branches!users_branch_id_fkey(id, name, code)
                    `)
                    .eq('role', 'trainer')
                    .eq('is_active', true)
                    .order('full_name');

                if (trainersError) {
                    resultsDiv.innerHTML += `<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–µ—Ä–æ–≤: ${trainersError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<h2>üë• –¢—Ä–µ–Ω–µ—Ä—ã —Å —Ñ–∏–ª–∏–∞–ª–∞–º–∏:</h2>`;
                    trainers.forEach(t => {
                        const branch = Array.isArray(t.branch) ? t.branch[0] : t.branch;
                        resultsDiv.innerHTML += `<p>- ${t.full_name}: —Ñ–∏–ª–∏–∞–ª ${branch?.name || '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: ${t.branch_id || '–Ω–µ—Ç'})</p>`;
                    });
                }

                // 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç—Ä–µ–Ω–µ—Ä–æ–≤ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
                const { data: assignments, error: assignmentsError } = await supabase
                    .from('trainer_territories')
                    .select(`
                        id, trainer_id, territory_id, is_active,
                        trainer:users!trainer_territories_trainer_id_fkey(full_name),
                        territory:territories!trainer_territories_territory_id_fkey(name, region)
                    `)
                    .order('assigned_at', { ascending: false });

                if (assignmentsError) {
                    resultsDiv.innerHTML += `<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π: ${assignmentsError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<h2>üîó –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç—Ä–µ–Ω–µ—Ä–æ–≤ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏:</h2>`;
                    assignments.forEach(a => {
                        const trainer = Array.isArray(a.trainer) ? a.trainer[0] : a.trainer;
                        const territory = Array.isArray(a.territory) ? a.territory[0] : a.territory;
                        resultsDiv.innerHTML += `<p>- ${trainer?.full_name} ‚Üí ${territory?.name} (ID: ${a.territory_id})</p>`;
                    });
                }

                // 5. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
                resultsDiv.innerHTML += `<h2>üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:</h2>`;
                resultsDiv.innerHTML += `<p>–ü—Ä–æ–±–ª–µ–º–∞: –º—ã —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º branch_id (–∏–∑ branches) —Å territory_id (–∏–∑ territories)</p>`;
                resultsDiv.innerHTML += `<p>–≠—Ç–æ —Ä–∞–∑–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å —Ä–∞–∑–Ω—ã–º–∏ ID!</p>`;
                
                // –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º
                if (branches && territories) {
                    resultsDiv.innerHTML += `<h3>üîç –ü–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º:</h3>`;
                    branches.forEach(branch => {
                        const matchingTerritory = territories.find(t => 
                            t.name.toLowerCase() === branch.name.toLowerCase() ||
                            (t.region && t.region.toLowerCase() === branch.name.toLowerCase())
                        );
                        if (matchingTerritory) {
                            resultsDiv.innerHTML += `<p>‚úÖ –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: "${branch.name}" (branch ID: ${branch.id}) = "${matchingTerritory.name}" (territory ID: ${matchingTerritory.id})</p>`;
                        }
                    });
                }

            } catch (error) {
                resultsDiv.innerHTML += `<p>‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }

        debugTables();
    </script>
</body>
</html>
