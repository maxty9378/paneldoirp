<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –¢–µ—Å—Ç QR-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)</h1>
        
        <div class="test-section info">
            <h3>üìã –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º:</h3>
            <ul>
                <li>‚úÖ PKCE-–∫–æ–¥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ <code>exchangeCodeForSession</code></li>
                <li>‚úÖ Magic link —Ç–æ–∫–µ–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ <code>setSession</code></li>
                <li>‚úÖ OTP —Ç–æ–∫–µ–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ <code>verifyOtp</code></li>
                <li>‚úÖ –û—Ç–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ-–ø–∞—Ä—Å–∏–Ω–≥ URL –≤ Supabase –∫–ª–∏–µ–Ω—Ç–µ</li>
                <li>‚úÖ App.tsx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ /auth/callback</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîó –¢–µ—Å—Ç 1: PKCE-–∫–æ–¥ –≤ URL</h3>
            <p>–°–∏–º—É–ª–∏—Ä—É–µ–º URL —Å PKCE-–∫–æ–¥–æ–º (—Å–∞–º—ã–π —á–∞—Å—Ç—ã–π —Å–ª—É—á–∞–π –¥–ª—è QR)</p>
            <button onclick="testPKCE()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å PKCE</button>
            <div id="pkce-result" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîó –¢–µ—Å—Ç 2: Magic link —Ç–æ–∫–µ–Ω—ã –≤ hash</h3>
            <p>–°–∏–º—É–ª–∏—Ä—É–µ–º URL —Å access_token/refresh_token –≤ hash</p>
            <button onclick="testMagicLinkHash()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Magic Link (hash)</button>
            <div id="magic-hash-result" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîó –¢–µ—Å—Ç 3: Magic link —Ç–æ–∫–µ–Ω –≤ search</h3>
            <p>–°–∏–º—É–ª–∏—Ä—É–µ–º URL —Å token –≤ search –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö</p>
            <button onclick="testMagicLinkSearch()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Magic Link (search)</button>
            <div id="magic-search-result" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîó –¢–µ—Å—Ç 4: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /auth/callback</h3>
            <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ App.tsx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ callback</p>
            <button onclick="testRedirect()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç</button>
            <div id="redirect-result" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä –û–±—â–∏–π –ª–æ–≥</h3>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <div id="general-log" class="log"></div>
        </div>
    </div>

    <script>
        function log(message, elementId = 'general-log') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById(elementId);
            if (logElement) {
                logElement.innerHTML += `[${timestamp}] ${message}\n`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            console.log(message);
        }

        function clearLog() {
            document.getElementById('general-log').innerHTML = '';
        }

        function testPKCE() {
            const resultDiv = document.getElementById('pkce-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '';
            
            log('üîë –¢–µ—Å—Ç–∏—Ä—É–µ–º PKCE-–∫–æ–¥...', 'pkce-result');
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º URL —Å PKCE-–∫–æ–¥–æ–º
            const testUrl = 'https://paneldoirp.vercel.app/auth/callback?code=test-pkce-code-123&state=test-state';
            log(`üìã –¢–µ—Å—Ç–æ–≤—ã–π URL: ${testUrl}`, 'pkce-result');
            
            // –ü–∞—Ä—Å–∏–º URL –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç AuthCallback
            const url = new URL(testUrl);
            const search = url.searchParams;
            const authCode = search.get('code');
            
            if (authCode) {
                log(`‚úÖ PKCE-–∫–æ–¥ –Ω–∞–π–¥–µ–Ω: ${authCode}`, 'pkce-result');
                log('‚úÖ AuthCallback –¥–æ–ª–∂–µ–Ω –≤—ã–∑–≤–∞—Ç—å exchangeCodeForSession()', 'pkce-result');
                log('‚úÖ –°–µ—Å—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'pkce-result');
            } else {
                log('‚ùå PKCE-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'pkce-result');
            }
        }

        function testMagicLinkHash() {
            const resultDiv = document.getElementById('magic-hash-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '';
            
            log('üîë –¢–µ—Å—Ç–∏—Ä—É–µ–º Magic Link (hash)...', 'magic-hash-result');
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º URL —Å —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ hash
            const testUrl = 'https://paneldoirp.vercel.app/auth/callback#access_token=test-access-token&refresh_token=test-refresh-token&expires_in=3600';
            log(`üìã –¢–µ—Å—Ç–æ–≤—ã–π URL: ${testUrl}`, 'magic-hash-result');
            
            // –ü–∞—Ä—Å–∏–º URL –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç AuthCallback
            const url = new URL(testUrl);
            const search = url.searchParams;
            const hash = new URLSearchParams(testUrl.split('#')[1] || '');
            
            const at = search.get('access_token') || hash.get('access_token');
            const rt = search.get('refresh_token') || hash.get('refresh_token');
            
            if (at && rt) {
                log(`‚úÖ –¢–æ–∫–µ–Ω—ã –Ω–∞–π–¥–µ–Ω—ã –≤ hash: access_token=${at}, refresh_token=${rt}`, 'magic-hash-result');
                log('‚úÖ AuthCallback –¥–æ–ª–∂–µ–Ω –≤—ã–∑–≤–∞—Ç—å setSession()', 'magic-hash-result');
                log('‚úÖ –°–µ—Å—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'magic-hash-result');
            } else {
                log('‚ùå –¢–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ hash', 'magic-hash-result');
            }
        }

        function testMagicLinkSearch() {
            const resultDiv = document.getElementById('magic-search-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '';
            
            log('üîë –¢–µ—Å—Ç–∏—Ä—É–µ–º Magic Link (search)...', 'magic-search-result');
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º URL —Å —Ç–æ–∫–µ–Ω–æ–º –≤ search
            const testUrl = 'https://paneldoirp.vercel.app/auth/callback?token=test-magic-token&type=magiclink';
            log(`üìã –¢–µ—Å—Ç–æ–≤—ã–π URL: ${testUrl}`, 'magic-search-result');
            
            // –ü–∞—Ä—Å–∏–º URL –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç AuthCallback
            const url = new URL(testUrl);
            const search = url.searchParams;
            const hash = new URLSearchParams('');
            
            const tokenHash = search.get('token') || hash.get('token');
            
            if (tokenHash) {
                log(`‚úÖ Magic link —Ç–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω: ${tokenHash}`, 'magic-search-result');
                log('‚úÖ AuthCallback –¥–æ–ª–∂–µ–Ω –≤—ã–∑–≤–∞—Ç—å verifyOtp()', 'magic-search-result');
                log('‚úÖ OTP –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω', 'magic-search-result');
            } else {
                log('‚ùå Magic link —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', 'magic-search-result');
            }
        }

        function testRedirect() {
            const resultDiv = document.getElementById('redirect-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '';
            
            log('üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /auth/callback...', 'redirect-result');
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ URL, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å—Å—è
            const testUrls = [
                'https://paneldoirp.vercel.app/?code=test-pkce-code',
                'https://paneldoirp.vercel.app/#access_token=test-token&refresh_token=test-refresh',
                'https://paneldoirp.vercel.app/?token=test-magic-token&type=magiclink'
            ];
            
            testUrls.forEach((testUrl, index) => {
                log(`\nüìã –¢–µ—Å—Ç ${index + 1}: ${testUrl}`, 'redirect-result');
                
                const url = new URL(testUrl);
                const { hash, search, pathname } = url;
                
                const hasPKCE = search.includes('code=');
                const hasHashTokens = hash.includes('access_token') || hash.includes('refresh_token') || hash.includes('token=');
                const hasSearchMagic = search.includes('token=') && search.includes('type=magiclink');
                
                if (hasPKCE || hasHashTokens || hasSearchMagic) {
                    const suffix = hasPKCE ? search : hash || search;
                    log(`‚úÖ App.tsx –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞: /auth/callback${suffix}`, 'redirect-result');
                } else {
                    log('‚ùå App.tsx –ù–ï –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å', 'redirect-result');
                }
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üöÄ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            log('üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ª–æ–≥–æ–≤');
        });
    </script>
</body>
</html>
