<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç QR –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-top: 0; }
        h2 { color: #0e9f6e; margin-top: 30px; border-bottom: 2px solid #0e9f6e; padding-bottom: 10px; }
        button {
            background: #0e9f6e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0c8558; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        .step { color: #a78bfa; font-weight: bold; }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin: 10px 0;
        }
        .result-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .token-display {
            background: #eff6ff;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ QR –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h1>
        <p>–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ–π —Ü–µ–ø–æ—á–∫–∏ QR –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>

        <h2>–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã user_qr_tokens</h2>
        <button onclick="checkQRTokensTable()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
        <div id="tableResult"></div>

        <h2>–®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR —Ç–æ–∫–µ–Ω–∞</h2>
        <input type="email" id="emailInput" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: doirp@sns.ru)" value="doirp@sns.ru">
        <button onclick="generateQRToken()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR —Ç–æ–∫–µ–Ω</button>
        <div id="generateResult"></div>

        <h2>–®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ QR</h2>
        <input type="text" id="tokenInput" placeholder="QR —Ç–æ–∫–µ–Ω (–±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)">
        <button onclick="testQRAuth()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
        <div id="authResult"></div>

        <h2>–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ RPC —Ñ—É–Ω–∫—Ü–∏–∏ get_qr_token_user</h2>
        <button onclick="checkRPCFunction()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å RPC —Ñ—É–Ω–∫—Ü–∏—é</button>
        <div id="rpcResult"></div>

        <h2>üìã –õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://oaockmesooydvausfoca.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hb2NrbWVzb295ZHZhdXNmb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzI4NDEsImV4cCI6MjA2Njk0ODg0MX0.gwWS35APlyST7_IUvQvJtGO4QmGsvbE95lnQf0H1PUE';

        let generatedToken = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function checkQRTokensTable() {
            log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã user_qr_tokens...', 'step');
            const resultDiv = document.getElementById('tableResult');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/user_qr_tokens?select=id,user_id,token,is_active,created_at&limit=5`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const tokens = await response.json();
                log(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ù–∞–π–¥–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: ${tokens.length}`, 'success');
                
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <strong>‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_qr_tokens —Ä–∞–±–æ—Ç–∞–µ—Ç</strong>
                        <p>–ù–∞–π–¥–µ–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: ${tokens.length}</p>
                        <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${tokens.filter(t => t.is_active).length}</p>
                        ${tokens.length > 0 ? `
                            <details>
                                <summary>–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω—ã</summary>
                                <pre>${JSON.stringify(tokens, null, 2)}</pre>
                            </details>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü—ã: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="result-box"><strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message}</div>`;
            }
        }

        async function generateQRToken() {
            const email = document.getElementById('emailInput').value;
            if (!email) {
                log('‚ùå –í–≤–µ–¥–∏—Ç–µ email', 'error');
                return;
            }

            log(`–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR —Ç–æ–∫–µ–Ω–∞ –¥–ª—è ${email}...`, 'step');
            const resultDiv = document.getElementById('generateResult');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-persistent-qr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                generatedToken = data.token;
                document.getElementById('tokenInput').value = generatedToken;
                
                log(`‚úÖ QR —Ç–æ–∫–µ–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${generatedToken.substring(0, 16)}...`, 'success');
                log(`üì± URL: ${data.persistentUrl}`, 'info');
                
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <strong>‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω</strong>
                        <div class="token-display">
                            <strong>–¢–æ–∫–µ–Ω:</strong> ${generatedToken}
                        </div>
                        <div class="token-display">
                            <strong>URL:</strong> ${data.persistentUrl}
                        </div>
                        <p><em>${data.message}</em></p>
                    </div>
                `;
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="result-box"><strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message}</div>`;
            }
        }

        async function testQRAuth() {
            const token = document.getElementById('tokenInput').value;
            if (!token) {
                log('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π', 'error');
                return;
            }

            log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å —Ç–æ–∫–µ–Ω–æ–º: ${token.substring(0, 16)}...`, 'step');
            const resultDiv = document.getElementById('authResult');

            try {
                log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ auth-by-qr-token...', 'info');
                const response = await fetch(`${SUPABASE_URL}/functions/v1/auth-by-qr-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ token })
                });

                const data = await response.json();
                log(`üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                if (data.success) {
                    log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!`, 'success');
                    log(`üîó Redirect URL –ø–æ–ª—É—á–µ–Ω: ${data.redirectUrl ? '–î–∞' : '–ù–µ—Ç'}`, 'info');
                    
                    resultDiv.innerHTML = `
                        <div class="result-box">
                            <strong>‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</strong>
                            ${data.redirectUrl ? `
                                <div class="token-display">
                                    <strong>Redirect URL:</strong><br>
                                    ${data.redirectUrl.substring(0, 100)}...
                                </div>
                                <p><a href="${data.redirectUrl}" target="_blank">üîó –û—Ç–∫—Ä—ã—Ç—å redirect URL</a></p>
                            ` : ''}
                            <details>
                                <summary>–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="result-box"><strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message}</div>`;
            }
        }

        async function checkRPCFunction() {
            log('–ü—Ä–æ–≤–µ—Ä–∫–∞ RPC —Ñ—É–Ω–∫—Ü–∏–∏ get_qr_token_user...', 'step');
            const resultDiv = document.getElementById('rpcResult');
            const token = document.getElementById('tokenInput').value || generatedToken;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_qr_token_user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({ token_param: token || 'test_token' })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 404 || data.code === 'PGRST202') {
                        log('‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è get_qr_token_user –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î', 'warning');
                        log('‚ÑπÔ∏è Edge function –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback (–ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å)', 'info');
                        
                        resultDiv.innerHTML = `
                            <div class="result-box">
                                <strong>‚ö†Ô∏è RPC —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</strong>
                                <p>–§—É–Ω–∫—Ü–∏—è <code>get_qr_token_user</code> –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.</p>
                                <p><em>Edge function auth-by-qr-token –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback –º–µ—Ç–æ–¥ (–ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ).</em></p>
                                <p>–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.</p>
                            </div>
                        `;
                    } else {
                        throw new Error(data.message || `HTTP ${response.status}`);
                    }
                } else {
                    log(`‚úÖ RPC —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${JSON.stringify(data)}`, 'success');
                    resultDiv.innerHTML = `
                        <div class="result-box">
                            <strong>‚úÖ RPC —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç</strong>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ RPC: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="result-box"><strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message}</div>`;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            log('üöÄ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ QR –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—É—â–µ–Ω–∞', 'step');
            log(`üìç Supabase URL: ${SUPABASE_URL}`, 'info');
            checkQRTokensTable();
            checkRPCFunction();
        };
    </script>
</body>
</html>

