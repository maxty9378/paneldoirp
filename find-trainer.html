<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ —Ç—Ä–µ–Ω–µ—Ä–∞ –ö–∞–¥–æ—á–∫–∏–Ω –ú–∞–∫—Å–∏–º</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>üîç –ü–æ–∏—Å–∫ —Ç—Ä–µ–Ω–µ—Ä–∞ –ö–∞–¥–æ—á–∫–∏–Ω –ú–∞–∫—Å–∏–º</h1>
    <div id="results"></div>

    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏)
        const supabaseUrl = 'https://oaockmesooydvausfoca.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hb2NrbWVzb295ZHZhdXNmb2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzI4NDEsImV4cCI6MjA2Njk0ODg0MX0.gwWS35APlyST7_IUvQvJtGO4QmGsvbE95lnQf0H1PUE';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        const resultsDiv = document.getElementById('results');

        async function findTrainer() {
            resultsDiv.innerHTML = '<p>üîç –ü–æ–∏—Å–∫ —Ç—Ä–µ–Ω–µ—Ä–∞ –ö–∞–¥–æ—á–∫–∏–Ω –ú–∞–∫—Å–∏–º...</p>';

            try {
                // 1. –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏
                const { data: trainers, error: trainerError } = await supabase
                    .from('users')
                    .select(`
                        id,
                        full_name,
                        email,
                        phone,
                        branch_id,
                        role,
                        subdivision,
                        branch_subrole,
                        status
                    `)
                    .or('full_name.ilike.%–ö–∞–¥–æ—á–∫–∏–Ω%,full_name.ilike.%–ú–∞–∫—Å–∏–º%–ö–∞–¥–æ—á–∫–∏–Ω%,email.ilike.%–∫–∞–¥–æ—á–∫–∏–Ω%')
                    .eq('role', 'trainer');

                if (trainerError) {
                    resultsDiv.innerHTML += `<p>‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ç—Ä–µ–Ω–µ—Ä–æ–≤: ${trainerError.message}</p>`;
                    return;
                }

                resultsDiv.innerHTML += `<h2>üë• –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–µ—Ä—ã:</h2>`;
                resultsDiv.innerHTML += `<pre>${JSON.stringify(trainers, null, 2)}</pre>`;

                // 2. –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç—Ä–µ–Ω–µ—Ä–∞, –ø–æ–ª—É—á–∏–º –µ–≥–æ —Ñ–∏–ª–∏–∞–ª
                if (trainers && trainers.length > 0) {
                    for (const trainer of trainers) {
                        if (trainer.branch_id) {
                            const { data: branch, error: branchError } = await supabase
                                .from('branches')
                                .select('id, name, code, address')
                                .eq('id', trainer.branch_id)
                                .single();

                            if (branchError) {
                                resultsDiv.innerHTML += `<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–∞ –¥–ª—è ${trainer.full_name}: ${branchError.message}</p>`;
                            } else {
                                resultsDiv.innerHTML += `<h3>üè¢ –§–∏–ª–∏–∞–ª —Ç—Ä–µ–Ω–µ—Ä–∞ ${trainer.full_name}:</h3>`;
                                resultsDiv.innerHTML += `<pre>${JSON.stringify(branch, null, 2)}</pre>`;
                            }
                        } else {
                            resultsDiv.innerHTML += `<p>‚ö†Ô∏è –£ —Ç—Ä–µ–Ω–µ—Ä–∞ ${trainer.full_name} –Ω–µ —É–∫–∞–∑–∞–Ω —Ñ–∏–ª–∏–∞–ª –±–∞–∑–∏—Ä–æ–≤–∞–Ω–∏—è</p>`;
                        }
                    }
                } else {
                    resultsDiv.innerHTML += `<p>‚ùå –¢—Ä–µ–Ω–µ—Ä –ö–∞–¥–æ—á–∫–∏–Ω –ú–∞–∫—Å–∏–º –Ω–µ –Ω–∞–π–¥–µ–Ω</p>`;
                    
                    // 3. –ü–æ–∫–∞–∂–µ–º –≤—Å–µ—Ö —Ç—Ä–µ–Ω–µ—Ä–æ–≤
                    const { data: allTrainers, error: allTrainersError } = await supabase
                        .from('users')
                        .select('id, full_name, email, branch_id')
                        .eq('role', 'trainer')
                        .order('full_name');

                    if (allTrainersError) {
                        resultsDiv.innerHTML += `<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Ç—Ä–µ–Ω–µ—Ä–æ–≤: ${allTrainersError.message}</p>`;
                    } else {
                        resultsDiv.innerHTML += `<h3>üë• –í—Å–µ —Ç—Ä–µ–Ω–µ—Ä—ã –≤ —Å–∏—Å—Ç–µ–º–µ:</h3>`;
                        allTrainers.forEach(t => {
                            resultsDiv.innerHTML += `<p>- ${t.full_name} (${t.email}) - —Ñ–∏–ª–∏–∞–ª: ${t.branch_id || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</p>`;
                        });
                    }
                }

                // 4. –ü–æ–∫–∞–∂–µ–º –≤—Å–µ —Ñ–∏–ª–∏–∞–ª—ã
                const { data: branches, error: branchesError } = await supabase
                    .from('branches')
                    .select('id, name, code, address')
                    .order('name');

                if (branchesError) {
                    resultsDiv.innerHTML += `<p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤: ${branchesError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<h3>üè¢ –í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã –≤ —Å–∏—Å—Ç–µ–º–µ:</h3>`;
                    branches.forEach(b => {
                        resultsDiv.innerHTML += `<p>- ${b.name} (${b.code || '–±–µ–∑ –∫–æ–¥–∞'}) - ID: ${b.id}</p>`;
                    });
                }

            } catch (error) {
                resultsDiv.innerHTML += `<p>‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞: ${error.message}</p>`;
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        findTrainer();
    </script>
</body>
</html>
